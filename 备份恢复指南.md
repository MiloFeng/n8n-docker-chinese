# ğŸ’¾ n8n å¤‡ä»½ä¸æ¢å¤æŒ‡å—

å®Œæ•´çš„å¤‡ä»½å’Œæ¢å¤è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒå®Œæ•´å¤‡ä»½å’Œå¢é‡å¤‡ä»½ã€‚

## ğŸ“‹ ç›®å½•

- [å¤‡ä»½ç­–ç•¥](#å¤‡ä»½ç­–ç•¥)
- [å®Œæ•´å¤‡ä»½](#å®Œæ•´å¤‡ä»½)
- [å¢é‡å¤‡ä»½](#å¢é‡å¤‡ä»½)
- [è‡ªåŠ¨å¤‡ä»½](#è‡ªåŠ¨å¤‡ä»½)
- [æ•°æ®æ¢å¤](#æ•°æ®æ¢å¤)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ğŸ¯ å¤‡ä»½ç­–ç•¥

### æ¨èæ–¹æ¡ˆ

| å¤‡ä»½ç±»å‹ | é¢‘ç‡ | ä¿ç•™æ—¶é—´ | è¯´æ˜ |
|---------|------|---------|------|
| å®Œæ•´å¤‡ä»½ | æ¯å‘¨ | 7 ä¸ª | æ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹ |
| å¢é‡å¤‡ä»½ | æ¯å¤© | 30 ä¸ª | æ¯å¤©å‡Œæ™¨ 3 ç‚¹ |
| æ‰‹åŠ¨å¤‡ä»½ | æŒ‰éœ€ | æ°¸ä¹… | é‡å¤§å˜æ›´å‰ |

### å¤‡ä»½å†…å®¹

- âœ… PostgreSQL æ•°æ®åº“
- âœ… n8n æ•°æ®å· (å·¥ä½œæµã€å‡­è¯ç­‰)
- âœ… é…ç½®æ–‡ä»¶ (docker-compose.yml, .env ç­‰)

## ğŸ“¦ å®Œæ•´å¤‡ä»½

### æ‰‹åŠ¨æ‰§è¡Œ

```bash
# æ‰§è¡Œå®Œæ•´å¤‡ä»½
./scripts/backup-incremental.sh full

# å¤‡ä»½æ–‡ä»¶ä½ç½®
ls -lh backups/full/
```

### å¤‡ä»½å†…å®¹

å®Œæ•´å¤‡ä»½åŒ…å«:
- `full-YYYYMMDD-HHMMSS-db.sql.gz` - æ•°æ®åº“å¤‡ä»½
- `full-YYYYMMDD-HHMMSS-data.tar.gz` - æ•°æ®å·å¤‡ä»½
- `full-YYYYMMDD-HHMMSS-config.tar.gz` - é…ç½®æ–‡ä»¶å¤‡ä»½
- `full-YYYYMMDD-HHMMSS-manifest.txt` - å¤‡ä»½æ¸…å•

## ğŸ”„ å¢é‡å¤‡ä»½

### å‰ææ¡ä»¶

å¿…é¡»å…ˆæ‰§è¡Œä¸€æ¬¡å®Œæ•´å¤‡ä»½ã€‚

### æ‰‹åŠ¨æ‰§è¡Œ

```bash
# æ‰§è¡Œå¢é‡å¤‡ä»½
./scripts/backup-incremental.sh inc

# å¤‡ä»½æ–‡ä»¶ä½ç½®
ls -lh backups/incremental/
```

### å¤‡ä»½å†…å®¹

å¢é‡å¤‡ä»½åŒ…å«:
- `inc-YYYYMMDD-HHMMSS-db.sql.gz` - æ•°æ®åº“å¤‡ä»½
- `inc-YYYYMMDD-HHMMSS-data.tar.gz` - å˜æ›´æ–‡ä»¶å¤‡ä»½
- `inc-YYYYMMDD-HHMMSS-manifest.txt` - å¤‡ä»½æ¸…å•

### ä¼˜åŠ¿

- âš¡ å¤‡ä»½é€Ÿåº¦å¿«
- ğŸ’¾ å ç”¨ç©ºé—´å°
- ğŸ”„ é€‚åˆé¢‘ç¹å¤‡ä»½

## â° è‡ªåŠ¨å¤‡ä»½

### è®¾ç½®è‡ªåŠ¨å¤‡ä»½

```bash
# è¿è¡Œè®¾ç½®è„šæœ¬
./scripts/setup-auto-backup.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨é…ç½®:
- æ¯å‘¨æ—¥å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œå®Œæ•´å¤‡ä»½
- æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ‰§è¡Œå¢é‡å¤‡ä»½ (å‘¨ä¸€åˆ°å‘¨å…­)

### æŸ¥çœ‹ Cron ä»»åŠ¡

```bash
# æŸ¥çœ‹å½“å‰çš„ cron ä»»åŠ¡
crontab -l | grep backup

# ç¼–è¾‘ cron ä»»åŠ¡
crontab -e
```

### æŸ¥çœ‹å¤‡ä»½æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/backup.log

# æŸ¥çœ‹æœ€è¿‘çš„å¤‡ä»½è®°å½•
tail -50 logs/backup.log
```

### è‡ªå®šä¹‰å¤‡ä»½æ—¶é—´

ç¼–è¾‘ crontab:

```bash
crontab -e
```

Cron æ—¶é—´æ ¼å¼:
```
åˆ† æ—¶ æ—¥ æœˆ å‘¨

ç¤ºä¾‹:
0 2 * * 0     # æ¯å‘¨æ—¥ 2:00
0 3 * * 1-6   # å‘¨ä¸€åˆ°å‘¨å…­ 3:00
0 4 1 * *     # æ¯æœˆ 1 å· 4:00
*/30 * * * *  # æ¯ 30 åˆ†é’Ÿ
```

## ğŸ”§ æ•°æ®æ¢å¤

### ä»å®Œæ•´å¤‡ä»½æ¢å¤

```bash
# 1. åœæ­¢æœåŠ¡
docker compose down

# 2. æ¢å¤æ•°æ®åº“
gunzip -c backups/full/full-YYYYMMDD-HHMMSS-db.sql.gz | \
  docker compose exec -T postgres psql -U n8n n8n

# 3. æ¢å¤æ•°æ®å·
docker run --rm \
  -v n8n_n8n_data:/data \
  -v $(pwd)/backups/full:/backup \
  alpine sh -c "cd /data && tar xzf /backup/full-YYYYMMDD-HHMMSS-data.tar.gz"

# 4. æ¢å¤é…ç½®æ–‡ä»¶ (å¯é€‰)
tar xzf backups/full/full-YYYYMMDD-HHMMSS-config.tar.gz

# 5. é‡å¯æœåŠ¡
docker compose up -d
```

### ä»å¢é‡å¤‡ä»½æ¢å¤

```bash
# 1. å…ˆæ¢å¤æœ€è¿‘çš„å®Œæ•´å¤‡ä»½ (å‚è€ƒä¸Šé¢æ­¥éª¤)

# 2. æŒ‰æ—¶é—´é¡ºåºæ¢å¤æ‰€æœ‰å¢é‡å¤‡ä»½
for backup in backups/incremental/inc-*.tar.gz; do
  echo "æ¢å¤: $backup"
  docker run --rm \
    -v n8n_n8n_data:/data \
    -v $(pwd)/backups/incremental:/backup \
    alpine sh -c "cd /data && tar xzf /backup/$(basename $backup)"
done

# 3. æ¢å¤å¢é‡æ•°æ®åº“å¤‡ä»½
for backup in backups/incremental/inc-*-db.sql.gz; do
  echo "æ¢å¤æ•°æ®åº“: $backup"
  gunzip -c "$backup" | docker compose exec -T postgres psql -U n8n n8n
done

# 4. é‡å¯æœåŠ¡
docker compose up -d
```

### ä½¿ç”¨æ¢å¤è„šæœ¬

```bash
# æ¢å¤åˆ°æœ€æ–°çŠ¶æ€
./scripts/restore.sh

# æ¢å¤åˆ°æŒ‡å®šå¤‡ä»½
./scripts/restore.sh backups/full/full-20240116-020000
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¤‡ä»½å‰æ£€æŸ¥

```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker compose ps

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker compose exec postgres pg_isready -U n8n
```

### 2. éªŒè¯å¤‡ä»½

```bash
# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
gunzip -t backups/full/full-*-db.sql.gz
tar tzf backups/full/full-*-data.tar.gz > /dev/null

# æŸ¥çœ‹å¤‡ä»½å¤§å°
du -sh backups/full/* backups/incremental/*
```

### 3. å¼‚åœ°å¤‡ä»½

```bash
# åŒæ­¥åˆ°è¿œç¨‹æœåŠ¡å™¨
rsync -avz backups/ user@remote-server:/path/to/backups/

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ (ç¤ºä¾‹: AWS S3)
aws s3 sync backups/ s3://your-bucket/n8n-backups/

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨ (ç¤ºä¾‹: é˜¿é‡Œäº‘ OSS)
ossutil cp -r backups/ oss://your-bucket/n8n-backups/
```

### 4. å®šæœŸæµ‹è¯•æ¢å¤

```bash
# åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•æ¢å¤æµç¨‹
# 1. åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
# 2. æ¢å¤æœ€æ–°å¤‡ä»½
# 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
# 4. éªŒè¯å·¥ä½œæµå¯ä»¥æ­£å¸¸è¿è¡Œ
```

### 5. ç›‘æ§å¤‡ä»½çŠ¶æ€

```bash
# æ£€æŸ¥æœ€è¿‘çš„å¤‡ä»½
ls -lht backups/full/ | head -5
ls -lht backups/incremental/ | head -5

# æ£€æŸ¥å¤‡ä»½æ—¥å¿—ä¸­çš„é”™è¯¯
grep -i error logs/backup.log

# è®¾ç½®å¤‡ä»½ç›‘æ§å‘Šè­¦
# å¦‚æœå¤‡ä»½å¤±è´¥ï¼Œå‘é€é€šçŸ¥
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¤‡ä»½å¤±è´¥

```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ£€æŸ¥ Docker æœåŠ¡
docker ps

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
docker compose exec postgres psql -U n8n -c "SELECT version();"

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
./scripts/backup-incremental.sh full 2>&1 | tee backup-debug.log
```

### æ¢å¤å¤±è´¥

```bash
# æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
gunzip -t backup-file.sql.gz

# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker compose exec postgres pg_isready

# æŸ¥çœ‹ PostgreSQL æ—¥å¿—
docker logs n8n-postgres

# æ¸…ç©ºæ•°æ®åº“é‡æ–°æ¢å¤
docker compose exec postgres psql -U n8n -c "DROP DATABASE n8n;"
docker compose exec postgres psql -U n8n -c "CREATE DATABASE n8n;"
```

### æƒé™é—®é¢˜

```bash
# ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
chmod +x scripts/backup-incremental.sh
chmod +x scripts/restore.sh

# ç¡®ä¿å¤‡ä»½ç›®å½•å¯å†™
chmod 755 backups/
```

## ğŸ“Š å¤‡ä»½ç»Ÿè®¡

### æŸ¥çœ‹å¤‡ä»½å ç”¨ç©ºé—´

```bash
# æ€»å¤‡ä»½å¤§å°
du -sh backups/

# å„ç±»å‹å¤‡ä»½å¤§å°
du -sh backups/full/
du -sh backups/incremental/

# æœ€å¤§çš„å¤‡ä»½æ–‡ä»¶
du -h backups/*/* | sort -rh | head -10
```

### å¤‡ä»½æ•°é‡ç»Ÿè®¡

```bash
# å®Œæ•´å¤‡ä»½æ•°é‡
ls -1 backups/full/ | wc -l

# å¢é‡å¤‡ä»½æ•°é‡
ls -1 backups/incremental/ | wc -l

# æœ€æ—§çš„å¤‡ä»½
ls -lt backups/full/ | tail -1
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ•…éšœæ’æŸ¥](TROUBLESHOOTING.md)
- [æ€§èƒ½ä¼˜åŒ–](PERFORMANCE.md)
- [ç›‘æ§å‘Šè­¦](monitoring/README.md)

---

**é‡è¦æç¤º**: 
- å®šæœŸæµ‹è¯•å¤‡ä»½æ¢å¤æµç¨‹
- ä¿æŒè‡³å°‘ 3 ä»½å¤‡ä»½ (æœ¬åœ°ã€å¼‚åœ°ã€äº‘ç«¯)
- é‡å¤§å˜æ›´å‰åŠ¡å¿…æ‰‹åŠ¨å¤‡ä»½

