# ðŸ”„ n8n è‡ªåŠ¨æ›´æ–°åŠŸèƒ½

ä½¿ç”¨ Watchtower å®žçŽ° Docker å®¹å™¨çš„è‡ªåŠ¨æ›´æ–°ã€‚

## ðŸŽ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… **è‡ªåŠ¨æ£€æŸ¥æ›´æ–°**: å®šæ—¶æ£€æŸ¥ Docker Hub ä¸Šçš„æ–°ç‰ˆæœ¬
- âœ… **è‡ªåŠ¨æ‹‰å–é•œåƒ**: å‘çŽ°æ–°ç‰ˆæœ¬æ—¶è‡ªåŠ¨æ‹‰å–
- âœ… **è‡ªåŠ¨é‡å¯å®¹å™¨**: ä½¿ç”¨æ–°é•œåƒé‡å¯å®¹å™¨
- âœ… **æ¸…ç†æ—§é•œåƒ**: è‡ªåŠ¨æ¸…ç†ä¸å†ä½¿ç”¨çš„æ—§é•œåƒ
- âœ… **æ»šåŠ¨æ›´æ–°**: é€ä¸ªæ›´æ–°å®¹å™¨ï¼Œå‡å°‘æœåŠ¡ä¸­æ–­
- âœ… **é€šçŸ¥æ”¯æŒ**: æ”¯æŒé‚®ä»¶ã€Slack ç­‰é€šçŸ¥æ–¹å¼

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨è‡ªåŠ¨æ›´æ–°æœåŠ¡

```bash
# ä½¿ç”¨å¸¦ Watchtower çš„ docker-compose
docker compose -f docker-compose.watchtower.yml up -d

# æŸ¥çœ‹ Watchtower æ—¥å¿—
docker logs -f n8n-watchtower
```

### 2. éªŒè¯é…ç½®

```bash
# æ£€æŸ¥ Watchtower çŠ¶æ€
docker ps | grep watchtower

# æŸ¥çœ‹æœ€è¿‘çš„æ›´æ–°æ—¥å¿—
docker logs n8n-watchtower --tail 50
```

## âš™ï¸ é…ç½®è¯´æ˜Ž

### æ›´æ–°æ—¶é—´é…ç½®

åœ¨ `docker-compose.watchtower.yml` ä¸­ä¿®æ”¹:

```yaml
environment:
  # æ–¹å¼ä¸€: ä½¿ç”¨ Cron è¡¨è¾¾å¼ (æŽ¨è)
  - WATCHTOWER_SCHEDULE=0 0 3 * * *  # æ¯å¤©å‡Œæ™¨ 3 ç‚¹
  
  # æ–¹å¼äºŒ: ä½¿ç”¨ç§’æ•°é—´éš”
  # - WATCHTOWER_POLL_INTERVAL=86400  # 24 å°æ—¶
```

#### Cron è¡¨è¾¾å¼æ ¼å¼

```
ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨

ç¤ºä¾‹:
0 0 3 * * *     # æ¯å¤©å‡Œæ™¨ 3 ç‚¹
0 0 */6 * * *   # æ¯ 6 å°æ—¶
0 30 2 * * 0    # æ¯å‘¨æ—¥å‡Œæ™¨ 2:30
0 0 4 1 * *     # æ¯æœˆ 1 å·å‡Œæ™¨ 4 ç‚¹
```

### æ›´æ–°ç­–ç•¥

```yaml
environment:
  # æ¸…ç†æ—§é•œåƒ
  - WATCHTOWER_CLEANUP=true
  
  # ä»…ç›‘æŽ§ä¸æ›´æ–° (æµ‹è¯•æ¨¡å¼)
  - WATCHTOWER_MONITOR_ONLY=false
  
  # æ»šåŠ¨é‡å¯ (é€ä¸ªæ›´æ–°)
  - WATCHTOWER_ROLLING_RESTART=true
  
  # æ ‡ç­¾è¿‡æ»¤ (ä»…æ›´æ–°å¸¦æ ‡ç­¾çš„å®¹å™¨)
  - WATCHTOWER_LABEL_ENABLE=true
```

### å®¹å™¨æ ‡ç­¾é…ç½®

åœ¨éœ€è¦è‡ªåŠ¨æ›´æ–°çš„å®¹å™¨ä¸Šæ·»åŠ æ ‡ç­¾:

```yaml
services:
  n8n:
    labels:
      # å¯ç”¨è‡ªåŠ¨æ›´æ–°
      - "com.centurylinklabs.watchtower.enable=true"
      
      # ä»…ç›‘æŽ§ä¸æ›´æ–°
      # - "com.centurylinklabs.watchtower.monitor-only=true"
```

## ðŸ“§ é€šçŸ¥é…ç½®

### é‚®ä»¶é€šçŸ¥

```yaml
environment:
  - WATCHTOWER_NOTIFICATIONS=email
  - WATCHTOWER_NOTIFICATION_EMAIL_FROM=watchtower@example.com
  - WATCHTOWER_NOTIFICATION_EMAIL_TO=admin@example.com
  - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=smtp.gmail.com
  - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=587
  - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=your-email@gmail.com
  - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=your-app-password
```

### Slack é€šçŸ¥

```yaml
environment:
  - WATCHTOWER_NOTIFICATIONS=slack
  - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
  - WATCHTOWER_NOTIFICATION_SLACK_IDENTIFIER=watchtower
  - WATCHTOWER_NOTIFICATION_SLACK_CHANNEL=#alerts
```

### é’‰é’‰é€šçŸ¥

```yaml
environment:
  - WATCHTOWER_NOTIFICATIONS=shoutrrr
  - WATCHTOWER_NOTIFICATION_URL=dingtalk://token@webhook
```

## ðŸ›¡ï¸ å®‰å…¨å»ºè®®

### 1. ä½¿ç”¨ä»…ç›‘æŽ§æ¨¡å¼æµ‹è¯•

é¦–æ¬¡ä½¿ç”¨æ—¶å»ºè®®å…ˆå¯ç”¨ç›‘æŽ§æ¨¡å¼:

```yaml
environment:
  - WATCHTOWER_MONITOR_ONLY=true
```

è§‚å¯Ÿä¸€æ®µæ—¶é—´åŽå†å¯ç”¨è‡ªåŠ¨æ›´æ–°ã€‚

### 2. å¤‡ä»½æ•°æ®

åœ¨å¯ç”¨è‡ªåŠ¨æ›´æ–°å‰ï¼Œç¡®ä¿:
- âœ… å·²é…ç½®è‡ªåŠ¨å¤‡ä»½
- âœ… å¤‡ä»½æ•°æ®å¯æ¢å¤
- âœ… æœ‰å›žæ»šæ–¹æ¡ˆ

### 3. æ›´æ–°å‰å¤‡ä»½

å¯ä»¥é…ç½®æ›´æ–°å‰è‡ªåŠ¨å¤‡ä»½:

```bash
# åˆ›å»ºæ›´æ–°å‰é’©å­è„šæœ¬
cat > /usr/local/bin/pre-update-backup.sh << 'EOF'
#!/bin/bash
# åœ¨æ›´æ–°å‰æ‰§è¡Œå¤‡ä»½
docker exec n8n /scripts/backup.sh
EOF

chmod +x /usr/local/bin/pre-update-backup.sh
```

### 4. ç‰ˆæœ¬é”å®š

å¦‚æžœä¸æƒ³è‡ªåŠ¨æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥é”å®šç‰ˆæœ¬:

```yaml
services:
  n8n:
    image: n8nio/n8n:1.0.0  # æŒ‡å®šç‰ˆæœ¬å·
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
```

## ðŸ“Š ç›‘æŽ§æ›´æ–°

### æŸ¥çœ‹æ›´æ–°æ—¥å¿—

```bash
# å®žæ—¶æŸ¥çœ‹æ—¥å¿—
docker logs -f n8n-watchtower

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œ
docker logs n8n-watchtower --tail 100

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´çš„æ—¥å¿—
docker logs n8n-watchtower --since 2024-01-01T00:00:00
```

### æ—¥å¿—çº§åˆ«

```yaml
environment:
  - WATCHTOWER_LOG_LEVEL=debug  # debug, info, warn, error
```

## ðŸ”§ é«˜çº§é…ç½®

### ä»…æ›´æ–°ç‰¹å®šå®¹å™¨

```bash
# å¯åŠ¨æ—¶æŒ‡å®šå®¹å™¨åç§°
docker run -d \
  --name watchtower \
  -v /var/run/docker.sock:/var/run/docker.sock \
  containrrr/watchtower \
  n8n n8n-postgres
```

### æ›´æ–°åŽæ‰§è¡Œå‘½ä»¤

```yaml
environment:
  - WATCHTOWER_LIFECYCLE_HOOKS=true
  
labels:
  - "com.centurylinklabs.watchtower.lifecycle.post-update=/scripts/post-update.sh"
```

### HTTP API æ¨¡å¼

```yaml
environment:
  - WATCHTOWER_HTTP_API_UPDATE=true
  - WATCHTOWER_HTTP_API_TOKEN=your-secret-token
ports:
  - "8080:8080"
```

æ‰‹åŠ¨è§¦å‘æ›´æ–°:

```bash
curl -H "Authorization: Bearer your-secret-token" \
  http://localhost:8080/v1/update
```

## ðŸš¨ æ•…éšœæŽ’æŸ¥

### Watchtower æ— æ³•æ‹‰å–é•œåƒ

```bash
# æ£€æŸ¥ Docker Hub è¿žæŽ¥
docker pull n8nio/n8n:latest

# æ£€æŸ¥ Watchtower æ—¥å¿—
docker logs n8n-watchtower | grep -i error
```

### å®¹å™¨æœªè‡ªåŠ¨æ›´æ–°

1. æ£€æŸ¥å®¹å™¨æ ‡ç­¾æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥æ›´æ–°æ—¶é—´é…ç½®
3. æŸ¥çœ‹ Watchtower æ—¥å¿—

```bash
# æ‰‹åŠ¨è§¦å‘æ›´æ–°æµ‹è¯•
docker exec n8n-watchtower watchtower --run-once
```

### æ›´æ–°åŽæœåŠ¡å¼‚å¸¸

```bash
# å›žæ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬
docker compose down
docker pull n8nio/n8n:previous-version
# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç‰ˆæœ¬
docker compose up -d

# ä»Žå¤‡ä»½æ¢å¤æ•°æ®
./scripts/restore.sh
```

## ðŸ“ æœ€ä½³å®žè·µ

1. **è®¾ç½®åˆç†çš„æ›´æ–°æ—¶é—´**
   - é€‰æ‹©ä¸šåŠ¡ä½Žå³°æœŸ
   - é¿å…å·¥ä½œæ—¶é—´æ›´æ–°

2. **å¯ç”¨é€šçŸ¥**
   - åŠæ—¶äº†è§£æ›´æ–°çŠ¶æ€
   - å¿«é€Ÿå“åº”æ›´æ–°é—®é¢˜

3. **å®šæœŸæ£€æŸ¥æ—¥å¿—**
   - ç¡®è®¤æ›´æ–°æ­£å¸¸æ‰§è¡Œ
   - å‘çŽ°æ½œåœ¨é—®é¢˜

4. **æµ‹è¯•çŽ¯å¢ƒå…ˆè¡Œ**
   - åœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯æ–°ç‰ˆæœ¬
   - ç¡®è®¤æ— é—®é¢˜åŽå†æ›´æ–°ç”Ÿäº§çŽ¯å¢ƒ

5. **ä¿ç•™å›žæ»šæ–¹æ¡ˆ**
   - ä¿ç•™æ—§ç‰ˆæœ¬é•œåƒ
   - å‡†å¤‡æ•°æ®å¤‡ä»½

## ðŸ”— ç›¸å…³èµ„æº

- [Watchtower å®˜æ–¹æ–‡æ¡£](https://containrrr.dev/watchtower/)
- [Watchtower GitHub](https://github.com/containrrr/watchtower)
- [Docker Hub - n8n](https://hub.docker.com/r/n8nio/n8n)

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ [æ•…éšœæŽ’æŸ¥æ–‡æ¡£](TROUBLESHOOTING.md)

