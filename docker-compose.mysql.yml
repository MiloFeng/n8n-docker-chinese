services:
  # n8n 主服务 (使用 MySQL)
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n-mysql
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    env_file:
      - .env
    environment:
      # 基础配置
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-changeme123}

      # MySQL 数据库配置
      - DB_TYPE=mysqldb
      - DB_MYSQLDB_HOST=${DB_MYSQLDB_HOST:-mysql}
      - DB_MYSQLDB_PORT=${DB_MYSQLDB_PORT:-3306}
      - DB_MYSQLDB_DATABASE=${DB_MYSQLDB_DATABASE:-n8n}
      - DB_MYSQLDB_USER=${DB_MYSQLDB_USER:-n8n}
      - DB_MYSQLDB_PASSWORD=${DB_MYSQLDB_PASSWORD:-n8n_password}

      # 时区设置
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-Asia/Shanghai}
      - TZ=${TZ:-Asia/Shanghai}

      # Webhook 配置
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      
      # 执行配置
      - EXECUTIONS_PROCESS=main
      - EXECUTIONS_MODE=regular
      
      # 日志级别
      - N8N_LOG_LEVEL=info
      
      # 加密密钥
      - N8N_ENCRYPTION_KEY=your-encryption-key-change-this
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-local-files:/files
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - n8n-network

  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: n8n-mysql-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=n8n
      - MYSQL_USER=n8n
      - MYSQL_PASSWORD=n8n_password
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'n8n', '-pn8n_password']
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - n8n-network

volumes:
  n8n_data:
    driver: local
  mysql_data:
    driver: local

networks:
  n8n-network:
    driver: bridge

